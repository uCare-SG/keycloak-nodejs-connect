## v2.2.2

- Fixed a bug where invalid_code or invalid_redirecturi error was raised.
- Added support for "request.kcoverrides.getRedirectUri"
- Updated util lib to uCare.io managed copy https://github.com/uCare-SG/keycloak-nodejs-auth-utils/tree/v2.2.2

**What does request.kcoverrides.getRedirectUri do?**

In the following situation, user will get 400: Bad request error when processing these middlewares: **user requested reset password in browser A, and opened the link and do password update in browser B**. When redirecting back, the user will get 400: Bad request when getting grant from code (at Keycloak.prototype.getGrantFromCode in index.js).

This is because the redirect_uri firstly sent to Keycloak server must match the redirect_uri saved in session. We know that session key is stored in cookie. Browser A and B cannot share the session value. This leads the redirect_uri not match, which gives the error.

**Solution**

We solved this issue by adding another middleware before all Keycloak middlewares, to provide a function to generate redirect_uri of the corresponding path. In this case, both redirect_uri sent to Keycloak server, and the one used to compare will be generated by this function. Supposedly, the function should return the same value for the same path.

**Usage**

Add a middleware for the route you want to fix the redirect_uri, before loading all keycloak middlewares.

```javascript

  const URL = require('url');

  // Add a middleware for the route you want to fix the redirect_uri
  // Must add before app.use(keycloak.middleware());
  app.use('/m/auth', function(request, response, next) {
    request.kcoverrides = {
      getRedirectUri: function(request) {
        // Function to generate redirectUrl
        // Return: URL string
        let host = request.hostname;
        let headerHost = request.headers.host.split(':');
        let port = headerHost[1] || '';
        let protocol = request.protocol;
        let pathname;
        if (request.originalUrl) {
          pathname = URL.parse(request.originalUrl).pathname;
        } else {
          pathname = URL.parse(request.url).pathname;
        }
        let redirectUrl = protocol + '://' + host + (port === '' ? '' : ':' + port) + pathname + '?auth_callback=1';
        return redirectUrl;
      },
    };
    return next();
  });


  app.use(keycloak.middleware());


  // This is the real handler
  app.use('/m/auth', keycloak.protect(), RequestUtil.authenticate, mAuth);

```
